---
title: "Analysis of US Polution Data"
author: "Isaac Murray"
date: "15 December 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Set up libraries.
library(ggplot2)
library(readr)
library(sqldf)
library(RH2)
library(grid)
library(gridExtra)
# Read in dataset.
pol <- read_csv("US_pollution_sample.csv", 
                col_types = cols('Date Local' = col_date(format = "%Y-%m-%d"), 
                                 'NO2 1st Max Value' = col_double()))
# Use to output summary
polsum <- pol

# Dedup dataset.
pol <- unique(pol[!is.na(pol$`CO AQI`) & !is.na(pol$`SO2 AQI`),])

# Add derived variables.
pol$unqref <- paste(as.character(pol$`State Code`),as.character(pol$`Site Num`))
pol$unqsite <- paste(as.character(pol$`County`),as.character(pol$`State`), sep=", ")
pol$unqsitemul <- paste(as.character(pol$`County`),as.character(pol$`State`), sep="\n")
pol$unqsitemul <- gsub(" ", "\n", pol$unqsitemul)
pol$urban <- !(pol$City=="Not in a city")
pol$year <- as.integer(format(pol$`Date Local`,'%Y'))
pol$shyear <- as.integer(format(pol$`Date Local`,'%y'))
pol$month <- as.integer(format(pol$`Date Local`,'%m'))
```

# Introduction

This report describes an exploratory data analysis of environmental polution data taken from the United States Environmental Protection Agency (EPA) website. 

# Dataset Description

The original EPA data is contained in multiple files and this has been combined and made available for download. The dataset being analysed is a subset of the downloaded data.  

The following table summarises the dataset variables. Descriptions are copied verbatim from the download site:

| Name              | Description                                                                   |R Data type |
|:------------------|:------------------------------------------------------------------------------|:------------|
| State Code        |The code allocated by US EPA to each state                                     | int |
| County code       |The code of counties in a specific state allocated by US EPA                   | int |
| Site Num          | The site number in a specific county allocated by US EPA                      | int |
| Address           | State of monitoring site                                                      | chr |
| State             | The code allocated by US EPA to each state                                    | int |
| County            | County of monitoring site                                                     | chr |
| City              | City of the monitoring site                                                   | chr | 
| Date Local        | Date of monitoring                                                            | Date |  
| NO2 Units         | The units measured for NO2                                                     | num | 
| NO2 Mean          | The arithmetic mean of concentration of NO2 within a given day                 | num | 
| NO2 AQI           | The calculated air quality index of NO2 within a given day                    | int |
| NO2 1st Max Value | The maximum value obtained for NO2 concentration in a given day                | num |
| NO2 1st Max Hour  | The hour when the maximum NO2 concentration was recorded in a given day        | num |

# Descriptive statistics and data artefacts
The dataset includes data collected at seven sites:  
`r paste(unique(pol$unqsite), sep="\n")`
These have been 
```{r descriptive, echo=FALSE}
#summary(polsum)
```
## Measurement sites and date range of plots  


The following plot shows the date ranges of the measurements taken at each site. The gaps indicate missing data. 
```{r missing, echo=FALSE}
ggplot(pol, aes(x=`Date Local`,y=unqsitemul)) + geom_point()
```

## Combining of measurements in the data

For SO2 and CO, two groups of measurements are represented as one group of variables in the data. Each measurement gives its own readings for mean, AQI, 1st Max Value and 1st Max Hour. The measurements can be distinguished by the presence of an AQI value of NA. The graphs below show count of differences between readings for 1st Max Hour value for a given date at a given site. For the purposes of the analysis that follows, it is not desirable to have more than one 1st Max Hour reading per site per day per polutant. As such, the measurements associated with SO2 AQI = NA and CO AQI = NA are arbitrarily excluded.

```{r maxDiff, echo=FALSE, message=FALSE, warning=FALSE}
m <- c(0,2805,
       1,1515,
       2,732,
       3,698,
       4,436,
       5,577,
       6,646,
       7,452,
       8,263,
       9,162,
       10,112,
       11,128,
       12,84,
       13,111,
       14,132,
       15,127,
       16,204,
       17,216,
       18,229,
       19,261,
       20,185,
       21,316,
       22,214,
       23,231)
m <- matrix(m,length(m)/2,2,byrow = T)
`CO 1st Max Hour Difference` <- m[,1]
Count <- m[,2]
df <- data.frame(`CO 1st Max Hour Difference`,Count)
p1 <- ggplot(df) + geom_bar(aes(x=`CO 1st Max Hour Difference`,y=Count),stat="identity")

m <- c(0,	3092,
       1,	4162,
       2,	5292,
       3,	1029,
       4,	835,
       5,	220,
       6,	251,
       7,	265,
       8,178,
       9,	154,
       10,	185,
       11,	106,
       12,	113,
       13,	137,
       14,	76,
       15,	88,
       16,	95,
       17,	50,
       18,	54,
       19,	49,
       20,	22,
       21,	31,
       22,	44,
       23,	16)
m <- matrix(m,length(m)/2,2,byrow = T)
`SO2 1st Max Hour Difference` <- m[,1]
Count <- m[,2]
df <- data.frame(`SO2 1st Max Hour Difference`,Count)
p2 <- ggplot(df) + geom_bar(aes(x=`SO2 1st Max Hour Difference`,y=Count),stat="identity")

grid.arrange(p1, p2)
```


## NO2 variables
```{r varNO2, echo=FALSE, message=FALSE, warning=FALSE}
div <- 100
bw <- max(pol$`NO2 Mean`)/div
p1 <- ggplot(data=pol) + aes(x=`NO2 Mean`) + geom_histogram(binwidth=bw) + scale_x_continuous(limits = c(-5, 45))
div <- 100
bw <- max(pol$`NO2 1st Max Value`)/div
p2 <- ggplot(data=pol) + aes(x=`NO2 1st Max Value`) + geom_histogram(binwidth=bw) + scale_x_continuous(limits = c(-5, 45))
bw <- max(pol$`NO2 AQI`)/div
p3 <- ggplot(data=pol) + aes(x=`NO2 AQI`) + geom_bar()# geom_histogram(binwidth=1) 
p4 <- ggplot(data=pol) + aes(x=`NO2 1st Max Hour`) + geom_bar()#geom_histogram(binwidth=1) 
grid.arrange(p1, p2, p3, p4)
```
### Artefacts ###  
#### NO2 1st Max Value  
Notwithstanding a measurement bias towards whole numbers of units, Baltimore, Maryland and Cass, North Dakota sites appear to measure NO2 1st Max Value to a greater precision than the other sites:  
```{r NO2MaxArt, echo=FALSE, message=FALSE, warning=FALSE}
div <- 250
bw <- max(pol$`NO2 1st Max Value`)/div
ggplot(data=pol) + aes(x=`NO2 1st Max Value`) + geom_histogram(binwidth=bw) + scale_x_continuous(limits = c(0,20))+ facet_wrap(~unqsite,scales="free")
```
#### NO2 AQI  
All sites indicate a bias towards the values '8' and '25' for NO2 AQI:  
```{r NO2AQIArt, echo=FALSE, message=FALSE, warning=FALSE}
bw <- max(pol$`NO2 AQI`)/div
ggplot(data=pol) + aes(x=`NO2 AQI`) + geom_bar()+ facet_wrap(~unqsite,scales="free")+ scale_x_continuous(limits = c(6,26))
```

## O3 variables
```{r varO3, echo=FALSE, message=FALSE, warning=FALSE}
div <- 100
bw <- max(pol$`O3 Mean`)/div
p1 <- ggplot(data=pol) + aes(x=`O3 Mean`) + geom_histogram(binwidth=bw)
div <- 200
bw <- max(pol$`O3 1st Max Value`)/div
p2 <- ggplot(data=pol) + aes(x=`O3 1st Max Value`) + geom_histogram(binwidth=bw)
bw <- max(pol$`O3 AQI`)/div
p3 <- ggplot(data=pol) + aes(x=`O3 AQI`) + geom_bar()
p4 <- ggplot(data=pol) + aes(x=`O3 1st Max Hour`) + geom_bar()
grid.arrange(p1, p2, p3, p4)
```

## SO2 variables
```{r varSO2, echo=FALSE, message=FALSE, warning=FALSE}
p1 <- ggplot(data=pol) + aes(x=`SO2 Mean`) + geom_histogram(binwidth=0.5)
p2 <- ggplot(data=pol) + aes(x=`SO2 1st Max Value`) + geom_histogram(binwidth=1) + scale_x_continuous(limits = c(-5, 45))
p3 <- ggplot(data=pol) + aes(x=`SO2 AQI`) + geom_bar()
p4 <- ggplot(data=pol) + aes(x=`SO2 1st Max Hour`) + geom_bar() 
grid.arrange(p1, p2, p3, p4)
```
### Artefacts ###  
All sites other than Baltimore, Maryland and arguabley Cass, North Dakota show a disproportionate frequency of zero value measurements.  
```{r artSO2, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=pol) + aes(x=`SO2 Mean`) + geom_histogram(binwidth=0.1)+ facet_wrap(~unqsite,scales="free")
```

## CO variables
```{r varCO, echo=FALSE, message=FALSE, warning=FALSE}
div <- 500
bw <- max(pol$`CO Mean`)/div
p1 <- ggplot(data=pol) + aes(x=`CO Mean`) + geom_histogram(binwidth=bw) #+ scale_x_continuous(limits = c(-.1, 1.2))
p2 <- ggplot(data=pol) + aes(x=`CO 1st Max Value`) + geom_histogram(binwidth=.1) + scale_x_continuous(limits = c(-.1, 1.5))
bw <- max(pol$`CO AQI`)/div
p3 <- ggplot(data=pol) + aes(x=`CO AQI`) + geom_bar()
p4 <- ggplot(data=pol) + aes(x=`CO 1st Max Hour`) + geom_bar()
grid.arrange(p1, p2, p3, p4)
```
### Artefacts ###
Artefacts
All sites other than Baltimore, Maryland a disproportionate frequency of zero measurements.
```{r artCO, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=pol) + aes(x=`SO2 Mean`) + geom_histogram(binwidth=0.1)+ facet_wrap(~unqsite,scales="free")
```

# Notable features of the data

## Line plots of means over time for each polutant
The mean daily concentration level of all polutants show a seasonal pattern; O3 has a summer peak as opposed to a winter peak in other polutants:  
```{r line, echo=FALSE}
p1 <- ggplot(pol, aes(x=`Date Local`,y=`NO2 Mean`)) + geom_line()# + facet_wrap(~unqsite,scales="free")
p2 <- ggplot(pol, aes(x=`Date Local`,y=`O3 Mean`)) + geom_line()# + facet_wrap(~unqsite,scales="free")
p3 <- ggplot(pol, aes(x=`Date Local`,y=`SO2 Mean`)) + geom_line()# + facet_wrap(~unqsite,scales="free")
p4 <- ggplot(pol, aes(x=`Date Local`,y=`CO Mean`)) + geom_line()# + facet_wrap(~unqsite,scales="free")
grid.arrange(p1, p2, p3, p4)
```
The seasonal SO2 pattern is more obvious in some sites than others. Of note is the comparatively high and constant SO2 levels at Cuyahoga, Ohio.  
```{r so2year, echo=FALSE}
#ggplot(pol, aes(x=`Date Local`,y=`SO2 Mean`)) + geom_line() + facet_wrap(~unqsite,scales="free")
ggplot(data=pol) + aes(reorder(month,`SO2 Mean`),`SO2 Mean`) + geom_boxplot() + scale_x_discrete(limits=unique(pol$month)) + facet_wrap(~unqsite,scales="free")
```
Plotting the time of day of peak polutant level shows features of note for the polutants measured:  
```{r peakPlot, echo=FALSE}
p1 <- ggplot(pol, aes(x=`Date Local`,y=`NO2 1st Max Hour`)) + geom_point(aes(alpha = 1/1000))# + facet_wrap(~unqsite,scales="free")
p2 <- ggplot(pol, aes(x=`Date Local`,y=`O3 1st Max Hour`)) + geom_point(aes(alpha = 1/1000))# + facet_wrap(~unqsite,scales="free")
p3 <- ggplot(pol, aes(x=`Date Local`,y=`SO2 1st Max Hour`)) + geom_point(aes(alpha = 1/1000))# + facet_wrap(~unqsite,scales="free")
p4 <- ggplot(pol, aes(x=`Date Local`,y=`CO 1st Max Hour`)) + geom_point(aes(alpha = 1/1000))# + facet_wrap(~unqsite,scales="free")
grid.arrange(p1, p2, p3, p4,nrow=4)
```

## Box plots of means by month of year for each polutant
```{r box2, echo=FALSE}
ggplot(data=pol) + aes(reorder(month,`NO2 Mean`),`NO2 Mean`) + geom_boxplot() + scale_x_discrete(limits=unique(pol$month)) + facet_wrap(~unqsite,scales="free")
ggplot(data=pol) + aes(reorder(month,`O3 Mean`),`O3 Mean`) + geom_boxplot() + scale_x_discrete(limits=unique(pol$month)) + facet_wrap(~unqsite,scales="free")
ggplot(data=pol) + aes(reorder(month,`SO2 Mean`),`SO2 Mean`) + geom_boxplot() + scale_x_discrete(limits=unique(pol$month)) + facet_wrap(~unqsite,scales="free")
ggplot(data=pol) + aes(reorder(month,`CO Mean`),`CO Mean`) + geom_boxplot() + scale_x_discrete(limits=unique(pol$month)) + facet_wrap(~unqsite,scales="free")
```

